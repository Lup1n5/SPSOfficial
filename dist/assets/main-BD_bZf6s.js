import{i as J,g as Y,a as G,o as V,s as W,r as a,b as o,c as k,d as p,e as z,f as D}from"./index-35c79a8a-DPYO9GKU.js";const H={apiKey:"AIzaSyAYjLbsdGgVccTHa_bpEaDh7orYmzldiMk",authDomain:"stewflandic-permission-system.firebaseapp.com",databaseURL:"https://stewflandic-permission-system-default-rtdb.firebaseio.com",projectId:"stewflandic-permission-system",storageBucket:"stewflandic-permission-system.firebasestorage.app",messagingSenderId:"1035943934052",appId:"1:1035943934052:web:d3b8c6802c9a99ec81c771"},X=J(H),M=Y(),r=G(X),Z=document.getElementById("spin-button"),_=document.getElementById("hiddenToggle"),j=document.getElementById("logged-in-view"),R=document.getElementById("logged-out-view"),ee=document.getElementById("user-email"),q=document.getElementById("signin-email-input"),E=document.getElementById("signin-password-input"),O=document.getElementById("sign-in-btn"),te=document.getElementById("logout-button"),x=document.querySelector(".chat-messages");document.querySelector(".chat-input-form");const g=document.querySelector(".chat-input"),T=document.querySelector(".send-button");var y="",b="";let u="",I=!1,C=[],B=!0,d=null;function P(){let t=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),e={sender:"Server",text:`${y} has disconnected.`,timestamp:t};const s=a(r,`messages/${u}`);o(s,e);for(var n=0;n<x.childElementCount;n++)x.removeChild(x.firstChild);z(M).then(()=>{}).catch(i=>{}),location.reload(!0)}const K=async()=>{const t=a(r,`admpings/${u}`);switch((await p(t)).val()){case"mute":case"muted":return await o(t,"muted"),!0;case"unmute":case"unmuted":return await o(t,"unmuted"),!1;default:return!1}};V(M,async t=>{if(t){u=t.uid,b=t.email,await K(),j.style.display="block",ee.innerText=b,await ie(),!sessionStorage.getItem("password")&&E.value==""?P():sessionStorage.getItem("email")!=b&&(sessionStorage.setItem("email",b),sessionStorage.setItem("password",E.value)),q.value="",E.value="",R.style.display="none",y=b;const e=a(r,`pings/${u}`),s=a(r,`users/${u}`);p(s).then(c=>{o(s,b),c.val()=="refresh"&&P()});const n=a(r,"users");p(n).then(c=>{C=c.val()});const i=a(r,`admpings/${u}`);k(i,c=>{switch(c.val()){case"mute":o(i,"muted");break;case"unmute":o(i,"unmuted");break;case"kick":o(i,"kicked"),P();break;case"ban":o(i,"banned"),P();break;default:return!1}});let l=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),S={sender:"Server",text:`${y} has connected.`,timestamp:l};const L=a(r,`messages/${u}`);o(L,S),p(e).then(c=>{c.val()||o(e,"x")});const f=a(r,`pings/${u}`);k(f,c=>{c.val()=="pinging"&&document.visibilityState!=="hidden"&&o(f,"recieved")});let v=!1;const w=a(r,"messages");p(w).then(c=>{Object.keys(c.val()).forEach(m=>{const A=a(r,`messages/${m}/text`);k(A,()=>{const F=a(r,`messages/${m}`);p(F).then(Q=>{let N=Q.val();N.sender!=y&&v&&(h(N),B&&console.log("Message received while app in foreground - showing in chat only"))})})}),v=!0})}else j.style.display="none",R.style.display="block"});O.addEventListener("click",()=>{W(M,q.value,E.value).then(t=>{t.user}).catch(t=>{t.code,t.message,E.value=""})});E.addEventListener("keypress",function(t){t.key==="Enter"&&(t.preventDefault(),O.click())});te.addEventListener("click",()=>{P()});const h=t=>{const e=document.createElement("div");let n=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}).replace(/[:APM]/g,""),i=t.timestamp.replace(/[:APM]/g,"");Math.abs(Number(i)-Number(n))<2&&(e.innerHTML=`<div class="message ${t.sender===y?"blue-bg":t.text.includes("@"+y.replace("@providenceday.org",""))==!0?"yello-bg":"gray-bg"}">
  <div class="message-top"><div class="message-sender">${t.sender.split(".")[0]}</div>
  <div class="message-timestamp">${t.timestamp}</div></div>
  <div class="message-text">${t.text}</div>
  </div>`,x.appendChild(e),x.scrollTop=x.scrollHeight)},se=async()=>{const t=a(r,"AdminMan");return(await p(t)).val()==u};T.addEventListener("click",async()=>{if(g.value.length>200){alert("Message too long. Please keep it under 200 characters."),g.value="";return}if(await se()&&g.value[0]=="/"&&g.value!="/tab"){let e=g.value.replace("/","").split(" "),s=null;if(e[1]&&(e[1][0]=="@"?(e[1]=e[1].substring(1),e[1].includes("@providenceday.org")||(e[1]=e[1]+"@providenceday.org"),s=e[1]):e[1][0]=="!"?(e[1]=e[1].substring(1),s=e[1]):e[1]=="on"||e[1]=="off"?s=e[1]:(e[1].includes("@providenceday.org")||(e[1]=e[1]+"@providenceday.org"),Object.entries(C).forEach(([n,i])=>{i===e[1]&&(s=n)}))),!s&&["mute","unmute","kick","sendAs"].includes(e[0])){alert("Please specify a valid user.");return}switch(e[0]){case"hide":e[1]=="on"?(I=!0,alert("You are now hidden.")):e[1]=="off"?(I=!1,alert("You are now visible.")):e[1]==""?alert(I?"You are hidden.":"You are visible."):alert("Please specify 'on', 'off' or nothing.");break;case"mute":const n=a(r,`admpings/${s}`);o(n,"mute"),k(n,c=>{if(c.val()==="muted"){let m={sender:"Server",text:`${e[1]} has been muted.`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};h(m),D(n)}});break;case"unmute":const i=a(r,`admpings/${s}`);o(i,"unmute"),k(i,c=>{if(c.val()==="unmuted"){let m={sender:"Server",text:`${e[1]} has been unmuted.`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};h(m),D(i)}});break;case"kick":const l=a(r,`admpings/${s}`);o(l,"kick");let S={sender:"Server",text:`Kick request sent to ${e[1]}...`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};h(S),k(l,c=>{if(c.val()==="kicked"){let m={sender:"Server",text:`${e[1]} has been successfully kicked.`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};h(m),D(l)}});break;case"sendAs":const L=a(r,`messages/${u}`);let f=e.slice(2).join(" ");if(!f){alert("Please specify a message to send.");return}let v={sender:e[1],text:f,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};o(L,v),h(v);break;case"help":let w={sender:"Server",text:"Available commands: /tab, /mute [user], /unmute [user], /kick [user], /sendAs [user] [message], /help",timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};h(w);break;default:alert("Unknown command.");break}g.value=""}if(g.value!="/tab"){let e=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),s={sender:y,text:g.value,timestamp:e};if(s.text){const n=a(r,`messages/${u}`);if(!await K()){await o(n,s);const i=a(r,"messageCount"),l=await p(i);await o(i,l.val()+1),await re(s)}h(s),g.value=""}}else{const e=a(r,"pings");p(e).then(s=>{Object.keys(s.val()).forEach(n=>{const i=a(r,`pings/${n}`);o(i,"pinging")}),setTimeout(function(){const n=a(r,"pings");let i=[];p(n).then(l=>{const S=Object.keys(l.val()),L=Object.values(l.val());for(var f=0;f<S.length;f++)L[f]=="recieved"&&i.push(S[f]);if(i.length==1){let w={sender:"TABLIST",text:"Nobody is online.",timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};h(w)}i.forEach(v=>{const w=a(r,`users/${v}`);p(w).then(c=>{let m=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),A={sender:"TABLIST",text:`${c.val()} is online.`,timestamp:m};c.val()!=y&&h(A)})})})},1e3)}),g.value=""}});g.addEventListener("keypress",function(t){t.key==="Enter"&&(t.preventDefault(),T.click())});const ne=document.querySelector(".hidden-form");ne.addEventListener("submit",t=>{t.preventDefault()});Z.addEventListener("click",()=>{sessionStorage.setItem("ishidden",_.checked),window.location.href="SPiN.html"});document.addEventListener("visibilitychange",()=>{B=!document.hidden,console.log("App visibility changed:",B?"foreground":"background")});"serviceWorker"in navigator&&window.addEventListener("load",async()=>{try{const t=await navigator.serviceWorker.register("./sw.js");console.log("ServiceWorker registered: ",t)}catch(t){console.log("ServiceWorker registration failed: ",t)}});async function ie(){try{if(await Notification.requestPermission()==="granted"){console.log("Notification permission granted");const e=await navigator.serviceWorker.ready;if("PushManager"in window)try{if(d=await e.pushManager.getSubscription(),!d)console.log("No existing subscription, creating new one..."),d=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:U("BJo1BD-PijqyL2M0xNwy0xvOfFurS2d2vxG7LK78OtqJDgoogUuQbPp-iJ6QpuQNqFf5ljXaUmoPjZwNC2DlGSY")});else{console.log("Existing subscription found, verifying validity...");try{const s=d.getKey("p256dh"),n=d.getKey("auth");if(!s||!n)throw new Error("Invalid subscription keys");console.log("Subscription is valid")}catch(s){console.log("Subscription invalid, creating new one:",s.message),await d.unsubscribe(),d=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:U("BJo1BD-PijqyL2M0xNwy0xvOfFurS2d2vxG7LK78OtqJDgoogUuQbPp-iJ6QpuQNqFf5ljXaUmoPjZwNC2DlGSY")})}}if(console.log("Push subscription:",d),d&&u){const s=a(r,`pushSubscriptions/${u}`);await o(s,{endpoint:d.endpoint,keys:{p256dh:$(d.getKey("p256dh")),auth:$(d.getKey("auth"))},userEmail:b})}}catch(s){console.log("Push subscription failed:",s)}}}catch(t){console.log("Notification permission error:",t)}}async function ae(){if(u)try{const t=await navigator.serviceWorker.ready,e=await t.pushManager.getSubscription();if(e){await e.unsubscribe(),console.log("Refreshing push subscription...");const s=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:U("BJo1BD-PijqyL2M0xNwy0xvOfFurS2d2vxG7LK78OtqJDgoogUuQbPp-iJ6QpuQNqFf5ljXaUmoPjZwNC2DlGSY")}),n=a(r,`pushSubscriptions/${u}`);await o(n,{endpoint:s.endpoint,keys:{p256dh:$(s.getKey("p256dh")),auth:$(s.getKey("auth"))},userEmail:b,lastRefreshed:Date.now()}),d=s,console.log("Push subscription refreshed successfully")}}catch(t){console.log("Error refreshing push subscription:",t)}}setInterval(ae,1440*60*1e3);function U(t){const e="=".repeat((4-t.length%4)%4),s=(t+e).replace(/\-/g,"+").replace(/_/g,"/"),n=window.atob(s),i=new Uint8Array(n.length);for(let l=0;l<n.length;++l)i[l]=n.charCodeAt(l);return i}function $(t){const e=new Uint8Array(t);let s="";return e.forEach(n=>s+=String.fromCharCode(n)),window.btoa(s)}async function re(t){try{const e={title:"New Message in SPS",body:`${t.sender.split("@")[0]}: ${t.text}`,sender:t.sender,messageText:t.text,timestamp:t.timestamp},s=a(r,`notificationQueue/${Date.now()}`);await o(s,{payload:e,senderUid:u,timestamp:Date.now()}),console.log("Notification queued for backend processing")}catch(e){console.log("Error sending notifications:",e)}}
