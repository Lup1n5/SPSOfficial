import"./style-C4L-ipDU.js";import{initializeApp as Y}from"https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js";import{getDatabase as z,ref as n,get as d,set as c,onValue as S,off as A}from"https://www.gstatic.com/firebasejs/9.1.3/firebase-database.js";import{getAuth as F,onAuthStateChanged as H,signInWithEmailAndPassword as N,signOut as V}from"https://www.gstatic.com/firebasejs/9.1.3/firebase-auth.js";const K={apiKey:"AIzaSyAYjLbsdGgVccTHa_bpEaDh7orYmzldiMk",authDomain:"stewflandic-permission-system.firebaseapp.com",databaseURL:"https://stewflandic-permission-system-default-rtdb.firebaseio.com",projectId:"stewflandic-permission-system",storageBucket:"stewflandic-permission-system.firebasestorage.app",messagingSenderId:"1035943934052",appId:"1:1035943934052:web:d3b8c6802c9a99ec81c771"},G=Y(K),D=F(),a=z(G),W=document.getElementById("spin-button"),_=document.getElementById("hiddenToggle"),P=document.getElementById("logged-in-view"),U=document.getElementById("logged-out-view"),J=document.getElementById("user-email"),M=document.getElementById("signin-email-input"),w=document.getElementById("signin-password-input"),R=document.getElementById("sign-in-btn"),Q=document.getElementById("logout-button"),E=document.querySelector(".chat-messages");document.querySelector(".chat-input-form");const l=document.querySelector(".chat-input"),T=document.querySelector(".send-button");var v="",y="";let m="",x=!1,j=[];function I(){let t=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),e={sender:"Server",text:`${v} has disconnected.`,timestamp:t};const i=n(a,`messages/${m}`);c(i,e);for(var o=0;o<E.childElementCount;o++)E.removeChild(E.firstChild);V(D).then(()=>{}).catch(s=>{}),location.reload(!0)}const C=async()=>{const t=n(a,`admpings/${m}`);switch((await d(t)).val()){case"mute":case"muted":return await c(t,"muted"),!0;case"unmute":case"unmuted":return await c(t,"unmuted"),!1;default:return!1}};H(D,async t=>{if(t){m=t.uid,y=t.email,await C(),P.style.display="block",J.innerText=y,!sessionStorage.getItem("password")&&w.value==""?I():sessionStorage.getItem("email")!=y&&(sessionStorage.setItem("email",y),sessionStorage.setItem("password",w.value)),M.value="",w.value="",U.style.display="none",v=y;const e=n(a,`pings/${m}`),i=n(a,`users/${m}`);d(i).then(r=>{c(i,y),r.val()=="refresh"&&I()});const o=n(a,"users");d(o).then(r=>{j=r.val()});const s=n(a,`admpings/${m}`);S(s,r=>{switch(r.val()){case"mute":c(s,"muted");break;case"unmute":c(s,"unmuted");break;case"kick":c(s,"kicked"),I();break;case"ban":c(s,"banned"),I();break;default:return!1}});let g=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),k={sender:"Server",text:`${v} has connected.`,timestamp:g};const $=n(a,`messages/${m}`);c($,k),d(e).then(r=>{r.val()||c(e,"x")});const f=n(a,`pings/${m}`);S(f,r=>{r.val()=="pinging"&&document.visibilityState!=="hidden"&&c(f,"recieved")});let h=!1;const b=n(a,"messages");d(b).then(r=>{Object.keys(r.val()).forEach(u=>{const L=n(a,`messages/${u}/text`);S(L,()=>{const O=n(a,`messages/${u}`);d(O).then(q=>{let B=q.val();B.sender!=v&&h&&p(B)})})}),h=!0})}else P.style.display="none",U.style.display="block"});R.addEventListener("click",()=>{N(D,M.value,w.value).then(t=>{t.user}).catch(t=>{t.code,t.message,w.value=""})});w.addEventListener("keypress",function(t){t.key==="Enter"&&(t.preventDefault(),R.click())});Q.addEventListener("click",()=>{I()});const p=t=>{const e=document.createElement("div");let o=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}).replace(/[:APM]/g,""),s=t.timestamp.replace(/[:APM]/g,"");Math.abs(Number(s)-Number(o))<2&&(e.innerHTML=`<div class="message ${t.sender===v?"blue-bg":t.text.includes("@"+v.replace("@providenceday.org",""))==!0?"yello-bg":"gray-bg"}">
  <div class="message-top"><div class="message-sender">${t.sender.split(".")[0]}</div>
  <div class="message-timestamp">${t.timestamp}</div></div>
  <div class="message-text">${t.text}</div>
  </div>`,E.appendChild(e),E.scrollTop=E.scrollHeight)},X=async()=>{const t=n(a,"AdminMan");return(await d(t)).val()==m};T.addEventListener("click",async()=>{if(l.value.length>200){alert("Message too long. Please keep it under 200 characters."),l.value="";return}if(await X()&&l.value[0]=="/"&&l.value!="/tab"){let e=l.value.replace("/","").split(" "),i=null;if(e[1]&&(e[1][0]=="@"?(e[1]=e[1].substring(1),e[1].includes("@providenceday.org")||(e[1]=e[1]+"@providenceday.org"),i=e[1]):e[1][0]=="!"?(e[1]=e[1].substring(1),i=e[1]):e[1]=="on"||e[1]=="off"?i=e[1]:(e[1].includes("@providenceday.org")||(e[1]=e[1]+"@providenceday.org"),Object.entries(j).forEach(([o,s])=>{s===e[1]&&(i=o)}))),!i&&["mute","unmute","kick","sendAs"].includes(e[0])){alert("Please specify a valid user.");return}switch(e[0]){case"hide":e[1]=="on"?(x=!0,alert("You are now hidden.")):e[1]=="off"?(x=!1,alert("You are now visible.")):e[1]==""?alert(x?"You are hidden.":"You are visible."):alert("Please specify 'on', 'off' or nothing.");break;case"mute":const o=n(a,`admpings/${i}`);c(o,"mute"),S(o,r=>{if(r.val()==="muted"){let u={sender:"Server",text:`${e[1]} has been muted.`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};p(u),A(o)}});break;case"unmute":const s=n(a,`admpings/${i}`);c(s,"unmute"),S(s,r=>{if(r.val()==="unmuted"){let u={sender:"Server",text:`${e[1]} has been unmuted.`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};p(u),A(s)}});break;case"kick":const g=n(a,`admpings/${i}`);c(g,"kick");let k={sender:"Server",text:`Kick request sent to ${e[1]}...`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};p(k),S(g,r=>{if(r.val()==="kicked"){let u={sender:"Server",text:`${e[1]} has been successfully kicked.`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};p(u),A(g)}});break;case"sendAs":const $=n(a,`messages/${m}`);let f=e.slice(2).join(" ");if(!f){alert("Please specify a message to send.");return}let h={sender:e[1],text:f,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};c($,h),p(h);break;case"help":let b={sender:"Server",text:"Available commands: /tab, /mute [user], /unmute [user], /kick [user], /sendAs [user] [message], /help",timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};p(b);break;default:alert("Unknown command.");break}l.value=""}if(l.value!="/tab"){let e=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),i={sender:v,text:l.value,timestamp:e};if(i.text){const o=n(a,`messages/${m}`);if(!await C()){await c(o,i);const s=n(a,"messageCount"),g=await d(s);await c(s,g.val()+1)}p(i),l.value=""}}else{const e=n(a,"pings");d(e).then(i=>{Object.keys(i.val()).forEach(o=>{const s=n(a,`pings/${o}`);c(s,"pinging")}),setTimeout(function(){const o=n(a,"pings");let s=[];d(o).then(g=>{const k=Object.keys(g.val()),$=Object.values(g.val());for(var f=0;f<k.length;f++)$[f]=="recieved"&&s.push(k[f]);if(s.length==1){let b={sender:"TABLIST",text:"Nobody is online.",timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};p(b)}s.forEach(h=>{const b=n(a,`users/${h}`);d(b).then(r=>{let u=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),L={sender:"TABLIST",text:`${r.val()} is online.`,timestamp:u};r.val()!=v&&p(L)})})})},1e3)}),l.value=""}});l.addEventListener("keypress",function(t){t.key==="Enter"&&(t.preventDefault(),T.click())});const Z=document.querySelector(".hidden-form");Z.addEventListener("submit",t=>{t.preventDefault()});W.addEventListener("click",()=>{sessionStorage.setItem("ishidden",_.checked),window.location.href="SPiN.html"});
