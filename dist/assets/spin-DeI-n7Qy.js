import"./style-C4L-ipDU.js";import{initializeApp as V}from"https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js";import{getDatabase as W,ref as s,get as h,onValue as v,set as u,off as L}from"https://www.gstatic.com/firebasejs/9.1.3/firebase-database.js";import{getAuth as J,signInWithEmailAndPassword as Q,signOut as Z}from"https://www.gstatic.com/firebasejs/9.1.3/firebase-auth.js";const ee={apiKey:"AIzaSyD68PbyrHLGNYf9Kg_Xb_XKiKegz-Kov7k",authDomain:"spin-a3d5a.firebaseapp.com",projectId:"spin-a3d5a",storageBucket:"spin-a3d5a.firebasestorage.app",messagingSenderId:"423644329992",appId:"1:423644329992:web:9c14f1c959b8db636639bd"},te=V(ee),O=J(),r=W(te);let E=null;const ne=document.getElementById("user-name"),se=document.getElementById("logout-button"),U=document.querySelector(".chat-messages"),S=document.querySelector(".chat-input"),z=document.querySelector(".send-button");let a="";const T=s(r,"userCount"),re=s(r,"messages"),ae=sessionStorage.getItem("email"),ie=sessionStorage.getItem("password");let p=sessionStorage.getItem("ishidden");function ue(e){e!="true"&&u(E,"recieved")}Q(O,ae,ie).then(e=>{const n=s(r,`usernames/${e.user.uid}`);h(n).then(i=>{a=i.val(),E=s(r,`pings/${a}`),ce(),v(E,()=>{ue(p)})})}).catch(e=>{const n=e.code,i=e.message;console.log(n,i),alert("Error: "+i)});function ce(){ne.innerText=a;let e=new Date().toLocaleString("en-US",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!0});if(p=="true"){let t={sender:"Server",text:`Connected as ${a} (Hidden)`,timestamp:e,id:m()};o(t)}else{u(E,"idle");let t={sender:"Server",text:`${a} has connected.`,timestamp:e,id:m()};const d=s(r,`messages/${a}`);u(d,t),o(t)}const n=s(r,`users/${a}`);u(n,a),h(T).then(t=>{u(T,t.val()+1)});let i={},l=!1;v(T,()=>{Object.keys(i).forEach(t=>{const d=s(r,`messages/${t}/text`);i[t]&&(L(d,i[t]),delete i[t])}),h(re).then(t=>{t.exists()&&Object.keys(t.val()).forEach(d=>{const I=s(r,`messages/${d}/text`);i[d]||(i[d]=v(I,y=>{if(y.exists()&&l){const b=s(r,`messages/${d}`);h(b).then(D=>{if(D.exists()){let $=D.val();const A=`msg-${CSS.escape(d)}`;$.sender!=a&&$.text!=`${a} has connected.`&&!document.querySelector(`[data-message-id="${A}"]`)&&o($)}})}}))})})}),setTimeout(()=>{l=!0},100)}se.addEventListener("click",()=>{if(p==!1){let e=new Date().toLocaleString("en-US",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!0}),n={sender:"Server",text:`${a} has disconnected.`,timestamp:e,id:m()};const i=s(r,`messages/${a}`);u(i,n)}Z(O),window.location.href="index.html"});const m=()=>`msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,o=e=>{if(document.querySelector(`[data-message-id="${e.id}"]`)||new Date(e.timestamp)<Date.now()-6e4)return;const n=document.createElement("div");n.setAttribute("data-message-id",e.id),n.innerHTML=`<div class="message ${e.sender===a?"blue-bg":e.text.replace('"',"").includes("@"+a.replaceAll('"',""))?"yello-bg":"gray-bg"}">
      <div class="message-sender">${e.timestamp}: ${e.sender.replaceAll('"',"")}</div>
      <div class="message-text">${e.text}</div>
    </div>`,U.appendChild(n),U.scrollTop=U.scrollHeight};z.addEventListener("click",()=>{if(S.value[0]!=="/"){let e=new Date().toLocaleString("en-US",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!0}),n={sender:a,text:S.value,timestamp:e,id:m()};if(n.text){const i=s(r,`messages/${a}`);u(i,n);const l=s(r,"messageCount");h(l).then(t=>{u(l,t.val()+1)}),o(n),S.value=""}}else{const e=s(r,`messages/${a}`);let n=S.value.replace("/","").split(" ");switch(n[0]){case"tab":const i=s(r,"pings");h(i).then(f=>{Object.keys(f.val()).forEach(g=>{const c=s(r,`pings/${g}`);u(c,"pinging")}),setTimeout(function(){const g=s(r,"pings");let c=[];h(g).then(k=>{console.log(k.val());const w=Object.keys(k.val()),_=Object.values(k.val());for(var x=0;x<w.length;x++)_[x]=="recieved"&&(w[x]==null?c.push("1 hidden user"):c.push(w[x]));if(console.log(c),c.length<2){let R={sender:"TABLIST",text:"Nobody is online.",timestamp:new Date().toLocaleString("en-US",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!0}),id:m()};o(R)}else c.forEach(q=>{const R=s(r,`users/${q}`);h(R).then(K=>{let F=new Date().toLocaleString("en-US",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!0}),G={sender:"TABLIST",text:`${K.val()} is online.`,timestamp:F,id:m()};K.val()!==a&&o(G)})})}),c.forEach(k=>{const w=s(r,`pings/${k}`);u(w,"idle")})},1e3)});break;case"mute":let l=n[1];if(!l){alert("Please specify a user to mute.");return}const t=s(r,`admpings/${l}`);u(t,"mute");const d=v(t,f=>{if(f.val()==="muted"){let g=new Date().toLocaleString("en-US",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!0}),c={sender:"Server",text:`${l} has been muted.`,timestamp:g,id:m()};o(c),L(t,d)}});break;case"unmute":if(l=n[1],!l){alert("Please specify a user to unmute.");return}u(t,"unmute");const I=v(t,f=>{if(f.val()==="unmuted"){let g=new Date().toLocaleString("en-US",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!0}),c={sender:"Server",text:`${l} has been unmuted.`,timestamp:g,id:m()};o(c),L(t,I)}});break;case"kick":let y=n[1];if(!y){alert("Please specify a user to kick.");return}const b=s(r,`admpings/${y}`);u(b,"kick");let D=new Date().toLocaleString("en-US",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!0}),$={sender:"Server",text:`Kick request sent to ${y}...`,timestamp:D,id:m()};o($);const A=v(b,f=>{if(f.val()==="kicked"){let g=new Date().toLocaleString("en-US",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!0}),c={sender:"Server",text:`${y} has been successfully kicked.`,timestamp:g,id:m()};o(c),L(b,A)}});break;case"hide":if(p==!0){alert("You are already hidden.");return}let C={sender:"Server",text:`${a} has disconnected.`,timestamp:new Date().toLocaleString("en-US",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!0}),id:m()};u(e,C),o(C),p=!0;break;case"unhide":if(p==!1){alert("You are already visible.");return}let H=new Date().toLocaleString("en-US",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!0}),M={sender:"Server",text:`${a} has connected.`,timestamp:H,id:m()};u(e,M),o(M),p=!1;break;case"sendAs":let j=n[1],B=n.slice(2).join(" ");if(!j||!B){alert("Please specify a user and a message to send.");return}const Y=s(r,`messages/${a}`);let N=new Date().toLocaleString("en-US",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!0}),P={sender:j,text:B,timestamp:N,id:m()};u(Y,P),o(P);break;case"help":let X={sender:"Server",text:"Available commands: /tab, /mute [user], /unmute [user], /kick [user], /hide, /unhide, /sendAs [user] [message], /help",timestamp:new Date().toLocaleString("en-US",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!0}),id:m()};o(X);break}S.value=""}});S.addEventListener("keypress",function(e){e.key==="Enter"&&(e.preventDefault(),z.click())});
