import{i as K,g as W,a as V,o as z,s as H,r as a,b as c,c as S,d as g,e as Q,f as x}from"./index-35c79a8a-DPYO9GKU.js";const G={apiKey:"AIzaSyAYjLbsdGgVccTHa_bpEaDh7orYmzldiMk",authDomain:"stewflandic-permission-system.firebaseapp.com",databaseURL:"https://stewflandic-permission-system-default-rtdb.firebaseio.com",projectId:"stewflandic-permission-system",storageBucket:"stewflandic-permission-system.firebasestorage.app",messagingSenderId:"1035943934052",appId:"1:1035943934052:web:d3b8c6802c9a99ec81c771"},J=K(G),D=W(),r=V(J),_=document.getElementById("spin-button"),X=document.getElementById("hiddenToggle"),M=document.getElementById("logged-in-view"),T=document.getElementById("logged-out-view"),Z=document.getElementById("user-email"),N=document.getElementById("signin-email-input"),E=document.getElementById("signin-password-input"),j=document.getElementById("sign-in-btn"),ee=document.getElementById("logout-button"),$=document.querySelector(".chat-messages");document.querySelector(".chat-input-form");const m=document.querySelector(".chat-input"),C=document.querySelector(".send-button");var y="",w="";let l="",P=!1,q=[],B=!0,v=null;function A(){let t=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),e={sender:"Server",text:`${y} has disconnected.`,timestamp:t};const n=a(r,`messages/${l}`);c(n,e);for(var i=0;i<$.childElementCount;i++)$.removeChild($.firstChild);Q(D).then(()=>{}).catch(s=>{}),location.reload(!0)}const O=async()=>{const t=a(r,`admpings/${l}`);switch((await g(t)).val()){case"mute":case"muted":return await c(t,"muted"),!0;case"unmute":case"unmuted":return await c(t,"unmuted"),!1;default:return!1}};z(D,async t=>{if(t){l=t.uid,w=t.email,await O(),M.style.display="block",Z.innerText=w,await se(),!sessionStorage.getItem("password")&&E.value==""?A():sessionStorage.getItem("email")!=w&&(sessionStorage.setItem("email",w),sessionStorage.setItem("password",E.value)),N.value="",E.value="",T.style.display="none",y=w;const e=a(r,`pings/${l}`),n=a(r,`users/${l}`);g(n).then(o=>{c(n,w),o.val()=="refresh"&&A()});const i=a(r,"users");g(i).then(o=>{q=o.val()});const s=a(r,`admpings/${l}`);S(s,o=>{switch(o.val()){case"mute":c(s,"muted");break;case"unmute":c(s,"unmuted");break;case"kick":c(s,"kicked"),A();break;case"ban":c(s,"banned"),A();break;default:return!1}});let u=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),k={sender:"Server",text:`${y} has connected.`,timestamp:u};const L=a(r,`messages/${l}`);c(L,k),g(e).then(o=>{o.val()||c(e,"x")});const f=a(r,`pings/${l}`);S(f,o=>{o.val()=="pinging"&&document.visibilityState!=="hidden"&&c(f,"recieved")});let h=!1;const b=a(r,"messages");g(b).then(o=>{Object.keys(o.val()).forEach(d=>{const I=a(r,`messages/${d}/text`);S(I,()=>{const F=a(r,`messages/${d}`);g(F).then(Y=>{let U=Y.val();U.sender!=y&&h&&(p(U),B&&console.log("Message received while app in foreground - showing in chat only"))})})}),h=!0})}else M.style.display="none",T.style.display="block"});j.addEventListener("click",()=>{H(D,N.value,E.value).then(t=>{t.user}).catch(t=>{t.code,t.message,E.value=""})});E.addEventListener("keypress",function(t){t.key==="Enter"&&(t.preventDefault(),j.click())});ee.addEventListener("click",()=>{A()});const p=t=>{const e=document.createElement("div");let i=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}).replace(/[:APM]/g,""),s=t.timestamp.replace(/[:APM]/g,"");Math.abs(Number(s)-Number(i))<2&&(e.innerHTML=`<div class="message ${t.sender===y?"blue-bg":t.text.includes("@"+y.replace("@providenceday.org",""))==!0?"yello-bg":"gray-bg"}">
  <div class="message-top"><div class="message-sender">${t.sender.split(".")[0]}</div>
  <div class="message-timestamp">${t.timestamp}</div></div>
  <div class="message-text">${t.text}</div>
  </div>`,$.appendChild(e),$.scrollTop=$.scrollHeight)},te=async()=>{const t=a(r,"AdminMan");return(await g(t)).val()==l};C.addEventListener("click",async()=>{if(m.value.length>200){alert("Message too long. Please keep it under 200 characters."),m.value="";return}if(await te()&&m.value[0]=="/"&&m.value!="/tab"){let e=m.value.replace("/","").split(" "),n=null;if(e[1]&&(e[1][0]=="@"?(e[1]=e[1].substring(1),e[1].includes("@providenceday.org")||(e[1]=e[1]+"@providenceday.org"),n=e[1]):e[1][0]=="!"?(e[1]=e[1].substring(1),n=e[1]):e[1]=="on"||e[1]=="off"?n=e[1]:(e[1].includes("@providenceday.org")||(e[1]=e[1]+"@providenceday.org"),Object.entries(q).forEach(([i,s])=>{s===e[1]&&(n=i)}))),!n&&["mute","unmute","kick","sendAs"].includes(e[0])){alert("Please specify a valid user.");return}switch(e[0]){case"hide":e[1]=="on"?(P=!0,alert("You are now hidden.")):e[1]=="off"?(P=!1,alert("You are now visible.")):e[1]==""?alert(P?"You are hidden.":"You are visible."):alert("Please specify 'on', 'off' or nothing.");break;case"mute":const i=a(r,`admpings/${n}`);c(i,"mute"),S(i,o=>{if(o.val()==="muted"){let d={sender:"Server",text:`${e[1]} has been muted.`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};p(d),x(i)}});break;case"unmute":const s=a(r,`admpings/${n}`);c(s,"unmute"),S(s,o=>{if(o.val()==="unmuted"){let d={sender:"Server",text:`${e[1]} has been unmuted.`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};p(d),x(s)}});break;case"kick":const u=a(r,`admpings/${n}`);c(u,"kick");let k={sender:"Server",text:`Kick request sent to ${e[1]}...`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};p(k),S(u,o=>{if(o.val()==="kicked"){let d={sender:"Server",text:`${e[1]} has been successfully kicked.`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};p(d),x(u)}});break;case"sendAs":const L=a(r,`messages/${l}`);let f=e.slice(2).join(" ");if(!f){alert("Please specify a message to send.");return}let h={sender:e[1],text:f,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};c(L,h),p(h);break;case"help":let b={sender:"Server",text:"Available commands: /tab, /mute [user], /unmute [user], /kick [user], /sendAs [user] [message], /help",timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};p(b);break;default:alert("Unknown command.");break}m.value=""}if(m.value!="/tab"){let e=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),n={sender:y,text:m.value,timestamp:e};if(n.text){const i=a(r,`messages/${l}`);if(!await O()){await c(i,n);const s=a(r,"messageCount"),u=await g(s);await c(s,u.val()+1),await ae(n)}p(n),m.value=""}}else{const e=a(r,"pings");g(e).then(n=>{Object.keys(n.val()).forEach(i=>{const s=a(r,`pings/${i}`);c(s,"pinging")}),setTimeout(function(){const i=a(r,"pings");let s=[];g(i).then(u=>{const k=Object.keys(u.val()),L=Object.values(u.val());for(var f=0;f<k.length;f++)L[f]=="recieved"&&s.push(k[f]);if(s.length==1){let b={sender:"TABLIST",text:"Nobody is online.",timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};p(b)}s.forEach(h=>{const b=a(r,`users/${h}`);g(b).then(o=>{let d=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),I={sender:"TABLIST",text:`${o.val()} is online.`,timestamp:d};o.val()!=y&&p(I)})})})},1e3)}),m.value=""}});m.addEventListener("keypress",function(t){t.key==="Enter"&&(t.preventDefault(),C.click())});const ne=document.querySelector(".hidden-form");ne.addEventListener("submit",t=>{t.preventDefault()});_.addEventListener("click",()=>{sessionStorage.setItem("ishidden",X.checked),window.location.href="SPiN.html"});document.addEventListener("visibilitychange",()=>{B=!document.hidden,console.log("App visibility changed:",B?"foreground":"background")});"serviceWorker"in navigator&&window.addEventListener("load",async()=>{try{const t=await navigator.serviceWorker.register("/sw.js");console.log("ServiceWorker registered: ",t)}catch(t){console.log("ServiceWorker registration failed: ",t)}});async function se(){try{if(await Notification.requestPermission()==="granted"){console.log("Notification permission granted");const e=await navigator.serviceWorker.ready;if("PushManager"in window)try{if(v=await e.pushManager.getSubscription(),v||(v=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:ie("BJo1BD-PijqyL2M0xNwy0xvOfFurS2d2vxG7LK78OtqJDgoogUuQbPp-iJ6QpuQNqFf5ljXaUmoPjZwNC2DlGSY")})),console.log("Push subscription:",v),v&&l){const n=a(r,`pushSubscriptions/${l}`);await c(n,{endpoint:v.endpoint,keys:{p256dh:R(v.getKey("p256dh")),auth:R(v.getKey("auth"))},userEmail:w})}}catch(n){console.log("Push subscription failed:",n)}}}catch(t){console.log("Notification permission error:",t)}}function ie(t){const e="=".repeat((4-t.length%4)%4),n=(t+e).replace(/\-/g,"+").replace(/_/g,"/"),i=window.atob(n),s=new Uint8Array(i.length);for(let u=0;u<i.length;++u)s[u]=i.charCodeAt(u);return s}function R(t){const e=new Uint8Array(t);let n="";return e.forEach(i=>n+=String.fromCharCode(i)),window.btoa(n)}async function ae(t){try{const e={title:"New Message in SPS",body:`${t.sender.split("@")[0]}: ${t.text}`,sender:t.sender,messageText:t.text,timestamp:t.timestamp},n=a(r,`notificationQueue/${Date.now()}`);await c(n,{payload:e,senderUid:l,timestamp:Date.now()}),console.log("Notification queued for backend processing")}catch(e){console.log("Error sending notifications:",e)}}
