import{i as Q,g as G,a as z,o as J,s as Z,r as o,b as a,c as E,d as m,e as C,f as L}from"./index-35c79a8a-BbvXkxeG.js";const _={apiKey:"AIzaSyAYjLbsdGgVccTHa_bpEaDh7orYmzldiMk",authDomain:"stewflandic-permission-system.firebaseapp.com",databaseURL:"https://stewflandic-permission-system-default-rtdb.firebaseio.com",projectId:"stewflandic-permission-system",storageBucket:"stewflandic-permission-system.firebasestorage.app",messagingSenderId:"1035943934052",appId:"1:1035943934052:web:d3b8c6802c9a99ec81c771"},X="1.0.0",ee=Q(_),T=G(),r=z(ee),te=document.getElementById("spin-button"),se=document.getElementById("hiddenToggle"),U=document.getElementById("logged-in-view"),N=document.getElementById("logged-out-view"),ne=document.getElementById("user-email"),K=document.getElementById("signin-email-input"),x=document.getElementById("signin-password-input"),W=document.getElementById("sign-in-btn"),ie=document.getElementById("logout-button"),A=document.querySelector(".chat-messages");document.querySelector(".chat-input-form");const h=document.querySelector(".chat-input"),j=document.querySelector(".send-button");document.querySelector(".error-screen");var k="",y="";let d="",$=!1,R=[],O=!0,c=null;function I(){let t=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),e={sender:"Server",text:`${k} has disconnected.`,timestamp:t};const n=o(r,`messages/${d}`);a(n,e);for(var s=0;s<A.childElementCount;s++)A.removeChild(A.firstChild);C(T).then(()=>{}).catch(i=>{}),location.reload(!0)}const q=async()=>{const t=o(r,`admpings/${d}`),e=await m(t),n=o(r,"version");switch(m(n).then(s=>{if(s.val()!==X)return alert("THIS IS AN INCOMPATIBLE VERSIO! PLEASE REMOVE AND RE-ADD SPS TO YOUR HOMESCREEN!"),C(T),!1}),e.val()){case"mute":case"muted":return await a(t,"muted"),!0;case"unmute":case"unmuted":return await a(t,"unmuted"),!1;default:return!1}};J(T,async t=>{if(t){d=t.uid,y=t.email,await q(),U.style.display="block",ne.innerText=y,await ae(),!sessionStorage.getItem("password")&&x.value==""?I():sessionStorage.getItem("email")!=y&&(sessionStorage.setItem("email",y),sessionStorage.setItem("password",x.value)),K.value="",x.value="",N.style.display="none",k=y;const e=o(r,`pings/${d}`),n=o(r,`users/${d}`);m(n).then(u=>{a(n,y),u.val()=="refresh"&&I()});const s=o(r,"users");m(s).then(u=>{R=u.val()});const i=o(r,`admpings/${d}`);E(i,u=>{switch(u.val()){case"mute":a(i,"muted");break;case"unmute":a(i,"unmuted");break;case"kick":a(i,"kicked"),I();break;case"ban":a(i,"banned"),I();break;default:return!1}});let l=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),g={sender:"Server",text:`${k} has connected.`,timestamp:l};const v=o(r,`messages/${d}`);a(v,g),m(e).then(u=>{u.val()||a(e,"x")});const p=o(r,`pings/${d}`);E(p,u=>{u.val()=="pinging"&&document.visibilityState!=="hidden"&&a(p,"recieved")});let w=!1;const S=o(r,"messages");m(S).then(u=>{Object.keys(u.val()).forEach(f=>{const D=o(r,`messages/${f}/text`);E(D,()=>{const Y=o(r,`messages/${f}`);m(Y).then(H=>{let M=H.val();M.sender!=k&&w&&(b(M),O&&console.log("Message received while app in foreground - showing in chat only"))})})}),w=!0})}else U.style.display="none",N.style.display="block"});W.addEventListener("click",()=>{Z(T,K.value,x.value).then(t=>{t.user}).catch(t=>{t.code,t.message,x.value=""})});x.addEventListener("keypress",function(t){t.key==="Enter"&&(t.preventDefault(),W.click())});ie.addEventListener("click",()=>{I()});const b=t=>{const e=document.createElement("div");let s=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}).replace(/[:APM]/g,""),i=t.timestamp.replace(/[:APM]/g,"");Math.abs(Number(i)-Number(s))<2&&(e.innerHTML=`<div class="message ${t.text.includes("@"+k.replace("@providenceday.org",""))==!0||t.text.includes("@everyone")?"yello-bg":"gray-bg"}">
  <div class="message-top"><div class="message-sender">${t.sender.split(".")[0].charAt(0).toUpperCase()+t.sender.split(".")[0].slice(1)}</div>
  <div class="message-timestamp">${t.timestamp}</div></div>
  <div class="message-text">${t.text}</div>
  </div>`,A.appendChild(e),A.scrollTop=A.scrollHeight)},oe=async()=>{const t=o(r,"AdminMan");return(await m(t)).val()==d};j.addEventListener("click",async()=>{if(h.value.length>200){alert("Message too long. Please keep it under 200 characters."),h.value="";return}if(await oe()&&h.value[0]=="/"&&h.value!="/tab"){let e=h.value.replace("/","").split(" "),n=null;if(e[1]&&(e[1][0]=="@"?(e[1]=e[1].substring(1),e[1].includes("@providenceday.org")||(e[1]=e[1]+"@providenceday.org"),n=e[1]):e[1][0]=="!"?(e[1]=e[1].substring(1),n=e[1]):e[1]=="on"||e[1]=="off"?n=e[1]:(e[1].includes("@providenceday.org")||(e[1]=e[1]+"@providenceday.org"),Object.entries(R).forEach(([s,i])=>{i===e[1]&&(n=s)}))),!n&&["mute","unmute","kick","sendAs"].includes(e[0])){alert("Please specify a valid user.");return}switch(e[0]){case"hide":e[1]=="on"?($=!0,alert("You are now hidden.")):e[1]=="off"?($=!1,alert("You are now visible.")):e[1]==""?alert($?"You are hidden.":"You are visible."):alert("Please specify 'on', 'off' or nothing.");break;case"mute":const s=o(r,`admpings/${n}`);a(s,"mute"),E(s,u=>{if(u.val()==="muted"){let f={sender:"Server",text:`${e[1]} has been muted.`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};b(f),L(s)}});break;case"unmute":const i=o(r,`admpings/${n}`);a(i,"unmute"),E(i,u=>{if(u.val()==="unmuted"){let f={sender:"Server",text:`${e[1]} has been unmuted.`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};b(f),L(i)}});break;case"kick":const l=o(r,`admpings/${n}`);a(l,"kick");let g={sender:"Server",text:`Kick request sent to ${e[1]}...`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};b(g),E(l,u=>{if(u.val()==="kicked"){let f={sender:"Server",text:`${e[1]} has been successfully kicked.`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};b(f),L(l)}});break;case"sendAs":const v=o(r,`messages/${d}`);let p=e.slice(2).join(" ");if(!p){alert("Please specify a message to send.");return}let w={sender:e[1],text:p,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};a(v,w),b(w);break;case"help":let S={sender:"Server",text:"Available commands: /tab, /mute [user], /unmute [user], /kick [user], /sendAs [user] [message], /help",timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};b(S);break;default:alert("Unknown command.");break}h.value=""}if(h.value!="/tab"){let e=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),n={sender:k,text:h.value,timestamp:e};if(n.text){const s=o(r,`messages/${d}`);if(!await q()){await a(s,n);const i=o(r,"messageCount"),l=await m(i);await a(i,l.val()+1);let g=[];n.text.includes("@everyone")?await B(n,"*"):(Object.entries(R).forEach(([v,p])=>{n.text.includes("@"+p.split("@")[0])&&g.push(v)}),g.length!==0&&await B(n,g))}b(n),h.value=""}}else{const e=o(r,"pings");m(e).then(n=>{Object.keys(n.val()).forEach(s=>{const i=o(r,`pings/${s}`);a(i,"pinging")}),setTimeout(function(){const s=o(r,"pings");let i=[];m(s).then(l=>{const g=Object.keys(l.val()),v=Object.values(l.val());for(var p=0;p<g.length;p++)v[p]=="recieved"&&i.push(g[p]);if(i.length==1){let S={sender:"TABLIST",text:"Nobody is online.",timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};b(S)}i.forEach(w=>{const S=o(r,`users/${w}`);m(S).then(u=>{let f=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),D={sender:"TABLIST",text:`${u.val()} is online.`,timestamp:f};u.val()!=k&&b(D)})})})},1e3)}),h.value=""}});h.addEventListener("keypress",function(t){t.key==="Enter"&&(t.preventDefault(),j.click())});const re=document.querySelector(".hidden-form");re.addEventListener("submit",t=>{t.preventDefault()});te.addEventListener("click",()=>{sessionStorage.setItem("ishidden",se.checked),window.location.href="SPiN.html"});document.addEventListener("visibilitychange",()=>{O=!document.hidden,console.log("App visibility changed:",O?"foreground":"background")});"serviceWorker"in navigator&&window.addEventListener("load",async()=>{try{console.log("Registering service worker for iOS PWA...");const t={scope:"./"},e=await navigator.serviceWorker.register("./sw.js",t);console.log("ServiceWorker registered successfully:",{scope:e.scope,installing:e.installing,waiting:e.waiting,active:e.active}),e.addEventListener("updatefound",()=>{console.log("Service worker update found");const n=e.installing;n&&n.addEventListener("statechange",()=>{console.log("Service worker state changed:",n.state),n.state==="installed"&&navigator.serviceWorker.controller&&console.log("New service worker installed, refreshing...")})})}catch(t){console.log("ServiceWorker registration failed:",t),console.log("Error details:",{name:t.name,message:t.message,stack:t.stack})}});async function ae(){try{const t=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches||window.matchMedia("(display-mode: fullscreen)").matches;console.log("iOS PWA detected:",t),console.log("User Agent:",navigator.userAgent);const e=await Notification.requestPermission();if(console.log("Notification permission:",e),e==="granted"){console.log("Notification permission granted");const n=await Promise.race([navigator.serviceWorker.ready,new Promise((s,i)=>setTimeout(()=>i(new Error("Service worker timeout")),1e4))]);if(!("PushManager"in window)){console.log("Push messaging is not supported");return}if(!n.pushManager){console.log("Push manager unavailable in service worker registration");return}try{if(console.log("Setting up push subscription..."),c=await n.pushManager.getSubscription(),console.log("Existing subscription:",c?"Found":"None"),c){console.log("Validating existing subscription...");try{const s=c.endpoint,i=c.getKey("p256dh"),l=c.getKey("auth");if(!s||!i||!l)throw new Error("Invalid subscription components");if(c.expirationTime&&c.expirationTime<Date.now())throw new Error("Subscription expired");console.log("Subscription validation passed")}catch(s){console.log("Subscription validation failed:",s.message);try{await c.unsubscribe()}catch(i){console.log("Error unsubscribing invalid subscription:",i)}c=null}}if(!c){console.log("Creating new push subscription...");const s={userVisibleOnly:!0,applicationServerKey:V("BO7AQkuK-62TR28KVs30sTvXUIpGRaK-fF-Nv-ZrDP4KZ7EGEEHTQTcfUl7k3FlaekK6rQ3HLmhq0nlThhYfETs")};t&&(console.log("Adding iOS-specific subscription options"),s.userVisibleOnly=!0),c=await n.pushManager.subscribe(s),console.log("New subscription created successfully")}if(console.log("Final push subscription:",c),c&&d){const s=o(r,`pushSubscriptions/${d}`),i={endpoint:c.endpoint,keys:{p256dh:P(c.getKey("p256dh")),auth:P(c.getKey("auth"))},userEmail:y,userAgent:navigator.userAgent,isIOSPWA:t,created:Date.now(),lastRefreshed:Date.now()};c.expirationTime&&(i.expirationTime=c.expirationTime),await a(s,i),console.log("Subscription saved to Firebase")}}catch(s){console.log("Push subscription setup failed:",s),console.log("Error details:",{name:s.name,message:s.message,stack:s.stack})}}}catch(t){console.log("Notification permission error:",t)}}async function F(){if(!d){console.log("No user ID available for subscription refresh");return}try{console.log("Starting push subscription refresh...");const t=await navigator.serviceWorker.ready,e=await t.pushManager.getSubscription();if(e){const n=e.expirationTime&&e.expirationTime<Date.now()+864e5;if(n)console.log("Subscription is expiring soon, creating new one...");else{console.log("Subscription still valid, updating metadata only...");const g=o(r,`pushSubscriptions/${d}`),v=await m(g);v.exists()&&await a(g,{...v.val(),lastRefreshed:Date.now()});return}await e.unsubscribe(),console.log("Old subscription unsubscribed");const s=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:V("BJo1BD-PijqyL2M0xNwy0xvOfFurS2d2vxG7LK78OtqJDgoogUuQbPp-iJ6QpuQNqFf5ljXaUmoPjZwNC2DlGSY")}),i=o(r,`pushSubscriptions/${d}`),l={endpoint:s.endpoint,keys:{p256dh:P(s.getKey("p256dh")),auth:P(s.getKey("auth"))},userEmail:y,userAgent:navigator.userAgent,lastRefreshed:Date.now(),refreshReason:n?"expiration":"periodic"};s.expirationTime&&(l.expirationTime=s.expirationTime),await a(i,l),c=s,console.log("Push subscription refreshed successfully")}else console.log("No existing subscription found during refresh")}catch(t){console.log("Error refreshing push subscription:",t),console.log("Will retry setup on next app launch")}}setInterval(F,720*60*1e3);document.addEventListener("visibilitychange",()=>{!document.hidden&&c&&setTimeout(F,5e3)});function V(t){const e="=".repeat((4-t.length%4)%4),n=(t+e).replace(/\-/g,"+").replace(/_/g,"/"),s=window.atob(n),i=new Uint8Array(s.length);for(let l=0;l<s.length;++l)i[l]=s.charCodeAt(l);return i}function P(t){const e=new Uint8Array(t);let n="";return e.forEach(s=>n+=String.fromCharCode(s)),window.btoa(n)}async function B(t,e){try{const n={title:"New Message in SPS",body:`${t.sender.split("@")[0]}: ${t.text}`,sender:t.sender,messageText:t.text,timestamp:t.timestamp};console.log(e);const s=o(r,`notificationQueue/${Date.now()}`);await a(s,{payload:n,senderUid:d,targetUids:e,timestamp:Date.now()}),console.log("Notification queued for backend processing")}catch(n){console.log("Error sending notifications:",n)}}
