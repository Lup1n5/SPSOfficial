import{i as Y,g as Q,a as J,o as G,s as z,r as o,b as r,c as E,d as g,e as H,f as $}from"./index-35c79a8a-DPYO9GKU.js";const _={apiKey:"AIzaSyAYjLbsdGgVccTHa_bpEaDh7orYmzldiMk",authDomain:"stewflandic-permission-system.firebaseapp.com",databaseURL:"https://stewflandic-permission-system-default-rtdb.firebaseio.com",projectId:"stewflandic-permission-system",storageBucket:"stewflandic-permission-system.firebasestorage.app",messagingSenderId:"1035943934052",appId:"1:1035943934052:web:d3b8c6802c9a99ec81c771"},X=Y(_),M=Q(),a=J(X),Z=document.getElementById("spin-button"),ee=document.getElementById("hiddenToggle"),B=document.getElementById("logged-in-view"),N=document.getElementById("logged-out-view"),te=document.getElementById("user-email"),O=document.getElementById("signin-email-input"),x=document.getElementById("signin-password-input"),R=document.getElementById("sign-in-btn"),se=document.getElementById("logout-button"),A=document.querySelector(".chat-messages");document.querySelector(".chat-input-form");const p=document.querySelector(".chat-input"),j=document.querySelector(".send-button");var S="",y="";let d="",I=!1,q=[],T=!0,c=null;function P(){let t=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),e={sender:"Server",text:`${S} has disconnected.`,timestamp:t};const n=o(a,`messages/${d}`);r(n,e);for(var s=0;s<A.childElementCount;s++)A.removeChild(A.firstChild);H(M).then(()=>{}).catch(i=>{}),location.reload(!0)}const C=async()=>{const t=o(a,`admpings/${d}`);switch((await g(t)).val()){case"mute":case"muted":return await r(t,"muted"),!0;case"unmute":case"unmuted":return await r(t,"unmuted"),!1;default:return!1}};G(M,async t=>{if(t){d=t.uid,y=t.email,await C(),B.style.display="block",te.innerText=y,await oe(),!sessionStorage.getItem("password")&&x.value==""?P():sessionStorage.getItem("email")!=y&&(sessionStorage.setItem("email",y),sessionStorage.setItem("password",x.value)),O.value="",x.value="",N.style.display="none",S=y;const e=o(a,`pings/${d}`),n=o(a,`users/${d}`);g(n).then(u=>{r(n,y),u.val()=="refresh"&&P()});const s=o(a,"users");g(s).then(u=>{q=u.val()});const i=o(a,`admpings/${d}`);E(i,u=>{switch(u.val()){case"mute":r(i,"muted");break;case"unmute":r(i,"unmuted");break;case"kick":r(i,"kicked"),P();break;case"ban":r(i,"banned"),P();break;default:return!1}});let l=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),v={sender:"Server",text:`${S} has connected.`,timestamp:l};const b=o(a,`messages/${d}`);r(b,v),g(e).then(u=>{u.val()||r(e,"x")});const f=o(a,`pings/${d}`);E(f,u=>{u.val()=="pinging"&&document.visibilityState!=="hidden"&&r(f,"recieved")});let w=!1;const k=o(a,"messages");g(k).then(u=>{Object.keys(u.val()).forEach(m=>{const L=o(a,`messages/${m}/text`);E(L,()=>{const K=o(a,`messages/${m}`);g(K).then(V=>{let U=V.val();U.sender!=S&&w&&(h(U),T&&console.log("Message received while app in foreground - showing in chat only"))})})}),w=!0})}else B.style.display="none",N.style.display="block"});R.addEventListener("click",()=>{z(M,O.value,x.value).then(t=>{t.user}).catch(t=>{t.code,t.message,x.value=""})});x.addEventListener("keypress",function(t){t.key==="Enter"&&(t.preventDefault(),R.click())});se.addEventListener("click",()=>{P()});const h=t=>{const e=document.createElement("div");let s=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}).replace(/[:APM]/g,""),i=t.timestamp.replace(/[:APM]/g,"");Math.abs(Number(i)-Number(s))<2&&(e.innerHTML=`<div class="message ${t.sender===S?"blue-bg":t.text.includes("@"+S.replace("@providenceday.org",""))==!0?"yello-bg":"gray-bg"}">
  <div class="message-top"><div class="message-sender">${t.sender.split(".")[0]}</div>
  <div class="message-timestamp">${t.timestamp}</div></div>
  <div class="message-text">${t.text}</div>
  </div>`,A.appendChild(e),A.scrollTop=A.scrollHeight)},ne=async()=>{const t=o(a,"AdminMan");return(await g(t)).val()==d};j.addEventListener("click",async()=>{if(p.value.length>200){alert("Message too long. Please keep it under 200 characters."),p.value="";return}if(await ne()&&p.value[0]=="/"&&p.value!="/tab"){let e=p.value.replace("/","").split(" "),n=null;if(e[1]&&(e[1][0]=="@"?(e[1]=e[1].substring(1),e[1].includes("@providenceday.org")||(e[1]=e[1]+"@providenceday.org"),n=e[1]):e[1][0]=="!"?(e[1]=e[1].substring(1),n=e[1]):e[1]=="on"||e[1]=="off"?n=e[1]:(e[1].includes("@providenceday.org")||(e[1]=e[1]+"@providenceday.org"),Object.entries(q).forEach(([s,i])=>{i===e[1]&&(n=s)}))),!n&&["mute","unmute","kick","sendAs"].includes(e[0])){alert("Please specify a valid user.");return}switch(e[0]){case"hide":e[1]=="on"?(I=!0,alert("You are now hidden.")):e[1]=="off"?(I=!1,alert("You are now visible.")):e[1]==""?alert(I?"You are hidden.":"You are visible."):alert("Please specify 'on', 'off' or nothing.");break;case"mute":const s=o(a,`admpings/${n}`);r(s,"mute"),E(s,u=>{if(u.val()==="muted"){let m={sender:"Server",text:`${e[1]} has been muted.`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};h(m),$(s)}});break;case"unmute":const i=o(a,`admpings/${n}`);r(i,"unmute"),E(i,u=>{if(u.val()==="unmuted"){let m={sender:"Server",text:`${e[1]} has been unmuted.`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};h(m),$(i)}});break;case"kick":const l=o(a,`admpings/${n}`);r(l,"kick");let v={sender:"Server",text:`Kick request sent to ${e[1]}...`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};h(v),E(l,u=>{if(u.val()==="kicked"){let m={sender:"Server",text:`${e[1]} has been successfully kicked.`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};h(m),$(l)}});break;case"sendAs":const b=o(a,`messages/${d}`);let f=e.slice(2).join(" ");if(!f){alert("Please specify a message to send.");return}let w={sender:e[1],text:f,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};r(b,w),h(w);break;case"help":let k={sender:"Server",text:"Available commands: /tab, /mute [user], /unmute [user], /kick [user], /sendAs [user] [message], /help",timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};h(k);break;default:alert("Unknown command.");break}p.value=""}if(p.value!="/tab"){let e=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),n={sender:S,text:p.value,timestamp:e};if(n.text){const s=o(a,`messages/${d}`);if(!await C()){await r(s,n);const i=o(a,"messageCount"),l=await g(i);await r(i,l.val()+1),await ae(n)}h(n),p.value=""}}else{const e=o(a,"pings");g(e).then(n=>{Object.keys(n.val()).forEach(s=>{const i=o(a,`pings/${s}`);r(i,"pinging")}),setTimeout(function(){const s=o(a,"pings");let i=[];g(s).then(l=>{const v=Object.keys(l.val()),b=Object.values(l.val());for(var f=0;f<v.length;f++)b[f]=="recieved"&&i.push(v[f]);if(i.length==1){let k={sender:"TABLIST",text:"Nobody is online.",timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};h(k)}i.forEach(w=>{const k=o(a,`users/${w}`);g(k).then(u=>{let m=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),L={sender:"TABLIST",text:`${u.val()} is online.`,timestamp:m};u.val()!=S&&h(L)})})})},1e3)}),p.value=""}});p.addEventListener("keypress",function(t){t.key==="Enter"&&(t.preventDefault(),j.click())});const ie=document.querySelector(".hidden-form");ie.addEventListener("submit",t=>{t.preventDefault()});Z.addEventListener("click",()=>{sessionStorage.setItem("ishidden",ee.checked),window.location.href="SPiN.html"});document.addEventListener("visibilitychange",()=>{T=!document.hidden,console.log("App visibility changed:",T?"foreground":"background")});"serviceWorker"in navigator&&window.addEventListener("load",async()=>{try{console.log("Registering service worker for iOS PWA...");const t={scope:"./"},e=await navigator.serviceWorker.register("./sw.js",t);console.log("ServiceWorker registered successfully:",{scope:e.scope,installing:e.installing,waiting:e.waiting,active:e.active}),e.addEventListener("updatefound",()=>{console.log("Service worker update found");const n=e.installing;n&&n.addEventListener("statechange",()=>{console.log("Service worker state changed:",n.state),n.state==="installed"&&navigator.serviceWorker.controller&&console.log("New service worker installed, refreshing...")})})}catch(t){console.log("ServiceWorker registration failed:",t),console.log("Error details:",{name:t.name,message:t.message,stack:t.stack})}});async function oe(){try{const t=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches||window.matchMedia("(display-mode: fullscreen)").matches;console.log("iOS PWA detected:",t),console.log("User Agent:",navigator.userAgent);const e=await Notification.requestPermission();if(console.log("Notification permission:",e),e==="granted"){console.log("Notification permission granted");const n=await Promise.race([navigator.serviceWorker.ready,new Promise((s,i)=>setTimeout(()=>i(new Error("Service worker timeout")),1e4))]);if(!("PushManager"in window)){console.log("Push messaging is not supported");return}if(!n.pushManager){console.log("Push manager unavailable in service worker registration");return}try{if(console.log("Setting up push subscription..."),c=await n.pushManager.getSubscription(),console.log("Existing subscription:",c?"Found":"None"),c){console.log("Validating existing subscription...");try{const s=c.endpoint,i=c.getKey("p256dh"),l=c.getKey("auth");if(!s||!i||!l)throw new Error("Invalid subscription components");if(c.expirationTime&&c.expirationTime<Date.now())throw new Error("Subscription expired");console.log("Subscription validation passed")}catch(s){console.log("Subscription validation failed:",s.message);try{await c.unsubscribe()}catch(i){console.log("Error unsubscribing invalid subscription:",i)}c=null}}if(!c){console.log("Creating new push subscription...");const s={userVisibleOnly:!0,applicationServerKey:F("BJo1BD-PijqyL2M0xNwy0xvOfFurS2d2vxG7LK78OtqJDgoogUuQbPp-iJ6QpuQNqFf5ljXaUmoPjZwNC2DlGSY")};t&&(console.log("Adding iOS-specific subscription options"),s.userVisibleOnly=!0),c=await n.pushManager.subscribe(s),console.log("New subscription created successfully")}if(console.log("Final push subscription:",c),c&&d){const s=o(a,`pushSubscriptions/${d}`),i={endpoint:c.endpoint,keys:{p256dh:D(c.getKey("p256dh")),auth:D(c.getKey("auth"))},userEmail:y,userAgent:navigator.userAgent,isIOSPWA:t,created:Date.now(),lastRefreshed:Date.now()};c.expirationTime&&(i.expirationTime=c.expirationTime),await r(s,i),console.log("Subscription saved to Firebase")}}catch(s){console.log("Push subscription setup failed:",s),console.log("Error details:",{name:s.name,message:s.message,stack:s.stack})}}}catch(t){console.log("Notification permission error:",t)}}async function W(){if(!d){console.log("No user ID available for subscription refresh");return}try{console.log("Starting push subscription refresh...");const t=await navigator.serviceWorker.ready,e=await t.pushManager.getSubscription();if(e){const n=e.expirationTime&&e.expirationTime<Date.now()+864e5;if(n)console.log("Subscription is expiring soon, creating new one...");else{console.log("Subscription still valid, updating metadata only...");const v=o(a,`pushSubscriptions/${d}`),b=await g(v);b.exists()&&await r(v,{...b.val(),lastRefreshed:Date.now()});return}await e.unsubscribe(),console.log("Old subscription unsubscribed");const s=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:F("BJo1BD-PijqyL2M0xNwy0xvOfFurS2d2vxG7LK78OtqJDgoogUuQbPp-iJ6QpuQNqFf5ljXaUmoPjZwNC2DlGSY")}),i=o(a,`pushSubscriptions/${d}`),l={endpoint:s.endpoint,keys:{p256dh:D(s.getKey("p256dh")),auth:D(s.getKey("auth"))},userEmail:y,userAgent:navigator.userAgent,lastRefreshed:Date.now(),refreshReason:n?"expiration":"periodic"};s.expirationTime&&(l.expirationTime=s.expirationTime),await r(i,l),c=s,console.log("Push subscription refreshed successfully")}else console.log("No existing subscription found during refresh")}catch(t){console.log("Error refreshing push subscription:",t),console.log("Will retry setup on next app launch")}}setInterval(W,720*60*1e3);document.addEventListener("visibilitychange",()=>{!document.hidden&&c&&setTimeout(W,5e3)});function F(t){const e="=".repeat((4-t.length%4)%4),n=(t+e).replace(/\-/g,"+").replace(/_/g,"/"),s=window.atob(n),i=new Uint8Array(s.length);for(let l=0;l<s.length;++l)i[l]=s.charCodeAt(l);return i}function D(t){const e=new Uint8Array(t);let n="";return e.forEach(s=>n+=String.fromCharCode(s)),window.btoa(n)}async function ae(t){try{const e={title:"New Message in SPS",body:`${t.sender.split("@")[0]}: ${t.text}`,sender:t.sender,messageText:t.text,timestamp:t.timestamp},n=o(a,`notificationQueue/${Date.now()}`);await r(n,{payload:e,senderUid:d,timestamp:Date.now()}),console.log("Notification queued for backend processing")}catch(e){console.log("Error sending notifications:",e)}}
