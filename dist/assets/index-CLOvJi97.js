import{initializeApp as N}from"https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js";import{getDatabase as Y,ref as i,get as g,set as u,onValue as k,off as A}from"https://www.gstatic.com/firebasejs/9.1.3/firebase-database.js";import{getAuth as F,onAuthStateChanged as z,signInWithEmailAndPassword as H,signOut as V}from"https://www.gstatic.com/firebasejs/9.1.3/firebase-auth.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const f of a.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&o(f)}).observe(document,{childList:!0,subtree:!0});function n(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(t){if(t.ep)return;t.ep=!0;const a=n(t);fetch(t.href,a)}})();const K={apiKey:"AIzaSyAYjLbsdGgVccTHa_bpEaDh7orYmzldiMk",authDomain:"stewflandic-permission-system.firebaseapp.com",databaseURL:"https://stewflandic-permission-system-default-rtdb.firebaseio.com",projectId:"stewflandic-permission-system",storageBucket:"stewflandic-permission-system.firebasestorage.app",messagingSenderId:"1035943934052",appId:"1:1035943934052:web:d3b8c6802c9a99ec81c771"},G=N(K),D=F(),r=Y(G),W=document.getElementById("spin-button"),_=document.getElementById("hiddenToggle"),B=document.getElementById("logged-in-view"),M=document.getElementById("logged-out-view"),J=document.getElementById("user-email"),U=document.getElementById("signin-email-input"),w=document.getElementById("signin-password-input"),O=document.getElementById("sign-in-btn"),Q=document.getElementById("logout-button"),L=document.querySelector(".chat-messages");document.querySelector(".chat-input-form");const m=document.querySelector(".chat-input"),R=document.querySelector(".send-button");var y="",S="";let d="",x=!1,T=[];function $(){let s=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),e={sender:"Server",text:`${y} has disconnected.`,timestamp:s};const n=i(r,`messages/${d}`);u(n,e);for(var o=0;o<L.childElementCount;o++)L.removeChild(L.firstChild);V(D).then(()=>{}).catch(t=>{}),location.reload(!0)}const j=async()=>{const s=i(r,`admpings/${d}`);switch((await g(s)).val()){case"mute":case"muted":return await u(s,"muted"),!0;case"unmute":case"unmuted":return await u(s,"unmuted"),!1;default:return!1}};z(D,async s=>{if(s){d=s.uid,S=s.email,await j(),B.style.display="block",J.innerText=S,!sessionStorage.getItem("password")&&w.value==""?$():sessionStorage.getItem("email")!=S&&(sessionStorage.setItem("email",S),sessionStorage.setItem("password",w.value)),U.value="",w.value="",M.style.display="none",y=S;const e=i(r,`pings/${d}`),n=i(r,`users/${d}`);g(n).then(c=>{u(n,S),c.val()=="refresh"&&$()});const o=i(r,"users");g(o).then(c=>{T=c.val()});const t=i(r,`admpings/${d}`);k(t,c=>{switch(c.val()){case"mute":u(t,"muted");break;case"unmute":u(t,"unmuted");break;case"kick":u(t,"kicked"),$();break;case"ban":u(t,"banned"),$();break;default:return!1}});let a=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),f={sender:"Server",text:`${y} has connected.`,timestamp:a};const E=i(r,`messages/${d}`);u(E,f),g(e).then(c=>{c.val()||u(e,"x")});const p=i(r,`pings/${d}`);k(p,c=>{c.val()=="pinging"&&document.visibilityState!=="hidden"&&u(p,"recieved")});let v=!1;const b=i(r,"messages");g(b).then(c=>{Object.keys(c.val()).forEach(l=>{const I=i(r,`messages/${l}/text`);k(I,()=>{const C=i(r,`messages/${l}`);g(C).then(q=>{let P=q.val();P.sender!=y&&v&&h(P)})})}),v=!0})}else B.style.display="none",M.style.display="block"});O.addEventListener("click",()=>{H(D,U.value,w.value).then(s=>{s.user}).catch(s=>{s.code,s.message,w.value=""})});w.addEventListener("keypress",function(s){s.key==="Enter"&&(s.preventDefault(),O.click())});Q.addEventListener("click",()=>{$()});const h=s=>{const e=document.createElement("div");let o=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}).replace(/[:APM]/g,""),t=s.timestamp.replace(/[:APM]/g,"");Math.abs(Number(t)-Number(o))<2&&(e.innerHTML=`<div class="message ${s.sender===y?"blue-bg":s.text.includes("@"+y.replace("@providenceday.org",""))==!0?"yello-bg":"gray-bg"}">
  <div class="message-top"><div class="message-sender">${s.sender.split(".")[0]}</div>
  <div class="message-timestamp">${s.timestamp}</div></div>
  <div class="message-text">${s.text}</div>
  </div>`,L.appendChild(e),L.scrollTop=L.scrollHeight)},X=async()=>{const s=i(r,"AdminMan");return(await g(s)).val()==d};R.addEventListener("click",async()=>{if(m.value.length>200){alert("Message too long. Please keep it under 200 characters."),m.value="";return}if(await X()&&m.value[0]=="/"&&m.value!="/tab"){let e=m.value.replace("/","").split(" "),n=null;if(e[1]&&(e[1][0]=="@"?(e[1]=e[1].substring(1),e[1].includes("@providenceday.org")||(e[1]=e[1]+"@providenceday.org"),n=e[1]):e[1][0]=="!"?(e[1]=e[1].substring(1),n=e[1]):e[1]=="on"||e[1]=="off"?n=e[1]:(e[1].includes("@providenceday.org")||(e[1]=e[1]+"@providenceday.org"),Object.entries(T).forEach(([o,t])=>{t===e[1]&&(n=o)}))),!n&&["mute","unmute","kick","sendAs"].includes(e[0])){alert("Please specify a valid user.");return}switch(e[0]){case"hide":e[1]=="on"?(x=!0,alert("You are now hidden.")):e[1]=="off"?(x=!1,alert("You are now visible.")):e[1]==""?alert(x?"You are hidden.":"You are visible."):alert("Please specify 'on', 'off' or nothing.");break;case"mute":const o=i(r,`admpings/${n}`);u(o,"mute"),k(o,c=>{if(c.val()==="muted"){let l={sender:"Server",text:`${e[1]} has been muted.`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};h(l),A(o)}});break;case"unmute":const t=i(r,`admpings/${n}`);u(t,"unmute"),k(t,c=>{if(c.val()==="unmuted"){let l={sender:"Server",text:`${e[1]} has been unmuted.`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};h(l),A(t)}});break;case"kick":const a=i(r,`admpings/${n}`);u(a,"kick");let f={sender:"Server",text:`Kick request sent to ${e[1]}...`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};h(f),k(a,c=>{if(c.val()==="kicked"){let l={sender:"Server",text:`${e[1]} has been successfully kicked.`,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};h(l),A(a)}});break;case"sendAs":const E=i(r,`messages/${d}`);let p=e.slice(2).join(" ");if(!p){alert("Please specify a message to send.");return}let v={sender:e[1],text:p,timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};u(E,v),h(v);break;case"help":let b={sender:"Server",text:"Available commands: /tab, /mute [user], /unmute [user], /kick [user], /sendAs [user] [message], /help",timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};h(b);break;default:alert("Unknown command.");break}m.value=""}if(m.value!="/tab"){let e=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),n={sender:y,text:m.value,timestamp:e};if(n.text){const o=i(r,`messages/${d}`);if(!await j()){await u(o,n);const t=i(r,"messageCount"),a=await g(t);await u(t,a.val()+1)}h(n),m.value=""}}else{const e=i(r,"pings");g(e).then(n=>{Object.keys(n.val()).forEach(o=>{const t=i(r,`pings/${o}`);u(t,"pinging")}),setTimeout(function(){const o=i(r,"pings");let t=[];g(o).then(a=>{const f=Object.keys(a.val()),E=Object.values(a.val());for(var p=0;p<f.length;p++)E[p]=="recieved"&&t.push(f[p]);if(t.length==1){let b={sender:"TABLIST",text:"Nobody is online.",timestamp:new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})};h(b)}t.forEach(v=>{const b=i(r,`users/${v}`);g(b).then(c=>{let l=new Date().toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),I={sender:"TABLIST",text:`${c.val()} is online.`,timestamp:l};c.val()!=y&&h(I)})})})},1e3)}),m.value=""}});m.addEventListener("keypress",function(s){s.key==="Enter"&&(s.preventDefault(),R.click())});const Z=document.querySelector(".hidden-form");Z.addEventListener("submit",s=>{s.preventDefault()});W.addEventListener("click",()=>{sessionStorage.setItem("ishidden",_.checked),window.location.href="SPiN.html"});
